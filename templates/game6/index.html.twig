{% extends 'base.html.twig' %}

{% block title %}Simon dice{% endblock %}

{% block body %}
<style>
    body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:20px 20px 40px}
    .top-nav {
        margin: 10px 0 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        width: 100%;
        justify-content: center;
        max-width: 980px;
    }

    .nav-btn {
        background: rgba(255, 255, 255, 0.16);
        color: #fff;
        padding: 8px 14px;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.25);
        transition: transform 0.15s, box-shadow 0.15s, background 0.15s;
    }

    .nav-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
        background: rgba(255, 255, 255, 0.22);
    }

    .nav-btn.active-nav {
        background: #ffffff;
        color: #764ba2;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
    }

    .nav-btn.logout {
        background: #e74c3c;
        border-color: rgba(255, 255, 255, 0.25);
    }

    .nav-btn.logout:hover {
        background: #c0392b;
    }
    .game-container{background:white;padding:30px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center;max-width:600px;width:100%}
    h1{color:#667eea;margin-bottom:5px}
    .board{display:grid;grid-template-columns:repeat(2,220px);gap:12px;justify-content:center;margin:20px auto}
    .pad{width:220px;height:220px;border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:2.8rem;color:#fff;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.15);transition:filter .12s}
    .pad.green{background:#2ecc71}
    .pad.red{background:#e74c3c}
    .pad.yellow{background:#f1c40f;color:#333}
    .pad.blue{background:#3498db}
    .pad.dim{filter:brightness(.6)}
    .controls{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:12px}
    .btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:10px 18px;border-radius:20px;border:none;font-weight:bold}
    .info{margin-top:12px}
</style>

<div class="top-nav">
    <a class="nav-btn" href="{{ path('app_home') }}">‚Üê Inicio</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game1' %} active-nav{% endif %}" href="{{ path('app_game1') }}">Juego 1</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game2' %} active-nav{% endif %}" href="{{ path('app_game2') }}">Juego 2</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game3' %} active-nav{% endif %}" href="{{ path('app_game3') }}">Juego 3</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game4' %} active-nav{% endif %}" href="{{ path('app_game4') }}">Juego 4</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game5' %} active-nav{% endif %}" href="{{ path('app_game5') }}">Juego 5</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game6' %} active-nav{% endif %}" href="{{ path('app_game6') }}">Juego 6</a>
    {% if is_granted('ROLE_ADMIN') %}
    <a class="nav-btn" href="{{ path('app_admin') }}">Admin</a>
    {% endif %}
    <a class="nav-btn logout" href="{{ path('app_logout') }}">Cerrar sesi√≥n</a>
</div>

<div class="game-container">
    <h1>üîä Simon dice</h1>
    <div class="controls">
        <button class="btn" id="startBtn">Iniciar</button>
        <div style="min-width:24px"></div>
        <div class="info">Nivel: <strong id="level">0</strong> ‚Äî R√©cord: <strong id="best">0</strong></div>
    </div>

    <div class="board" id="board">
        <div class="pad green" data-color="green"></div>
        <div class="pad red" data-color="red"></div>
        <div class="pad yellow" data-color="yellow"></div>
        <div class="pad blue" data-color="blue"></div>
    </div>

    <p id="message" style="margin-top:10px;color:#333"></p>

    <div style="margin-top:18px; max-width:600px; margin-left:auto; margin-right:auto; text-align:left;">
        <h3 style="color:#667eea;margin-bottom:8px;">Top 10 (p√∫blico)</h3>
        <ol id="simonLeaderboard" style="background:#fff;padding:12px;border-radius:8px; list-style-position:inside;">
            <li>Cargando...</li>
        </ol>
        <p id="simonLeaderboardStatus" style="font-size:12px;color:#888;margin-top:8px;"></p>
    </div>
</div>

<script>
(function(){
    const pads = Array.from(document.querySelectorAll('.pad'));
    const startBtn = document.getElementById('startBtn');
    const levelEl = document.getElementById('level');
    const bestEl = document.getElementById('best');
    const message = document.getElementById('message');

    let seq = [];
    let player = [];
    let playing = false;
    let strict = false;

    const bestKey = 'simon_best';
    const best = localStorage.getItem(bestKey) || 0;
    bestEl.textContent = best;

    function randColor(){
        const choices = ['green','red','yellow','blue'];
        return choices[Math.floor(Math.random()*choices.length)];
    }

    function flash(color, duration=400){
        const pad = pads.find(p=>p.dataset.color===color);
        pad.classList.remove('dim');
        setTimeout(()=> pad.classList.add('dim'), duration);
    }

    async function playSequence(){
        playing = true;
        message.textContent = 'Observa la secuencia';
        for(let c of seq){
            await new Promise(r=> setTimeout(r, 400));
            flash(c, 500);
            await new Promise(r=> setTimeout(r, 500));
        }
        playing = false;
        message.textContent = 'Tu turno';
    }

    function nextRound(){
        seq.push(randColor());
        levelEl.textContent = seq.length;
        playSequence();
    }

    pads.forEach(p=>{
        p.addEventListener('click', ()=>{
            if(playing || seq.length===0) return;
            const color = p.dataset.color;
            flash(color,200);
            player.push(color);
            checkPlayer();
        });
    });

    function checkPlayer(){
        const i = player.length - 1;
        if(player[i] !== seq[i]){
            message.textContent = '¬°Incorrecto!';
            const achieved = seq.length - 1;
            if(seq.length > best){
                localStorage.setItem(bestKey, achieved);
                bestEl.textContent = achieved;
            }
            // Enviar resultado al servidor si hay usuario (guardar nivel alcanzado)
            submitSimonScore(achieved);

            seq = []; player = [];
            levelEl.textContent = 0;
            return;
        }
        if(player.length === seq.length){
            player = [];
            setTimeout(()=> nextRound(), 600);
        }
    }

    startBtn.addEventListener('click', ()=>{
        seq = []; player = [];
        nextRound();
        message.textContent = '';
    });

    // dim pads initially
    pads.forEach(p=>p.classList.add('dim'));

    // --- Leaderboard / persistence ---
    function fetchSimonLeaderboard() {
        const listEl = document.getElementById('simonLeaderboard');
        const statusEl = document.getElementById('simonLeaderboardStatus');
        if (!listEl || !statusEl) return;
        statusEl.textContent = 'Cargando ranking...';

        const data = {
            api_key: 'ABCDEFGHIJK1234567890',
            token_juego: 'SIMON_GAME_TOKEN_007'
        };

        fetch('{{ path("api_juego") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(result => {
            if (result.success && result.data && result.data['Listado jugadores']) {
                const jugadores = result.data['Listado jugadores'];
                listEl.innerHTML = '';
                if (jugadores.length === 0) listEl.innerHTML = '<li>No hay resultados</li>';
                else jugadores.forEach(j => {
                    const li = document.createElement('li');
                    li.textContent = `${j.jugador} ‚Äî ${j.Puntos}`;
                    listEl.appendChild(li);
                });
                statusEl.textContent = '';
            } else {
                statusEl.textContent = 'No hay datos disponibles';
            }
        })
        .catch(err => {
            console.error('Error cargando ranking Simon:', err);
            statusEl.textContent = 'Error al cargar ranking';
        });
    }

    // Submit a Simon score to the API (only if user is logged in)
    function submitSimonScore(level) {
        {% if app.user %}
        const payload = {
            api_key: 'ABCDEFGHIJK1234567890',
            token_usuario: '{{ app.user.email }}',
            token_juego: 'SIMON_GAME_TOKEN_007',
            puntos: String(level)
        };

        fetch('{{ path("api_juego_guardar") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(res => {
            console.log('Simon score saved', res);
            if (res.success) fetchSimonLeaderboard();
        })
        .catch(err => console.error('Error saving Simon score:', err));
        {% else %}
        // No-op when not logged in
        console.debug('No user logged in, Simon score not submitted');
        {% endif %}
    }

    // Call fetch on load
    fetchSimonLeaderboard();
})();
</script>

{% endblock %}
