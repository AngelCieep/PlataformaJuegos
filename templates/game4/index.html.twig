{% extends '_navbar.html.twig' %}

{% block title %}Ahorcado{% endblock %}

{% block page_content %}
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0 20px 20px;
    }
    .top-nav {
        margin: 20px 0 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .nav-btn {
        background: rgba(255, 255, 255, 0.16);
        color: #fff;
        padding: 8px 14px;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.25);
        transition: transform 0.15s, box-shadow 0.15s, background 0.15s;
    }
    .nav-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
        background: rgba(255, 255, 255, 0.22);
    }
    .nav-btn.active-nav {
        background: #ffffff;
        color: #00b09b;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
    }
    .nav-btn.logout {
        background: #e74c3c;
        border-color: rgba(255, 255, 255, 0.25);
    }
    .nav-btn.logout:hover {
        background: #c0392b;
    }
    .game-container {
        background: #fff;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.25);
        width: 100%;
        max-width: 900px;
    }
    h1 {
        text-align: center;
        color: #00b09b;
        margin-bottom: 10px;
        font-size: 2.6em;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    .subtitle { text-align: center; color: #555; margin-bottom: 25px; }
    .status-bar {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 20px;
    }
    .status-box {
        background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        color: #fff;
        padding: 12px 18px;
        border-radius: 12px;
        min-width: 170px;
        text-align: center;
        box-shadow: 0 6px 16px rgba(0,176,155,0.35);
    }
    .status-box h3 { font-size: 0.9em; opacity: 0.9; margin-bottom: 6px; }
    .status-box p { font-size: 1.6em; font-weight: bold; }
    .top-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    .hangman {
        background: #f6f8fb;
        border-radius: 15px;
        padding: 15px;
        border: 2px solid #e4ecf7;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    canvas { width: 100%; max-width: 350px; height: auto; }
    .word-panel {
        background: #f6f8fb;
        border-radius: 15px;
        padding: 20px;
        border: 2px solid #e4ecf7;
        display: flex;
        flex-direction: column;
        gap: 15px;
        justify-content: center;
    }
    .hidden-word {
        letter-spacing: 8px;
        font-size: 2.2em;
        text-align: center;
        font-weight: bold;
        color: #333;
    }
    .category { text-align: center; color: #00b09b; font-weight: bold; }
    .message { text-align: center; font-size: 1.2em; color: #e67e22; min-height: 26px; }
    .keyboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(48px, 1fr)); gap: 10px; margin-top: 15px; }
    .key {
        background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 10px 0;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.15s;
    }
    .key:disabled { opacity: 0.45; cursor: not-allowed; transform: none; box-shadow: none; }
    .key:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 14px rgba(0,176,155,0.35); }
    .controls { text-align: center; margin-top: 18px; }
    .btn {
        background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
        color: white;
        border: none;
        padding: 12px 28px;
        border-radius: 25px;
        font-size: 1em;
        cursor: pointer;
        margin: 4px;
        font-weight: bold;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(255,94,98,0.35); }
    .btn.secondary { background: #6c757d; }
    .instructions {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 18px;
        margin-top: 18px;
    }
    .instructions h3 { color: #00b09b; margin-bottom: 8px; }
    .instructions ul { color: #555; list-style-position: inside; }
    .instructions li { margin: 6px 0; }
    @media (max-width: 768px) {
        .top-row { grid-template-columns: 1fr; }
    }
    .leaderboard li span.points { float: right; color: #00b09b; font-weight:700; }
    .leaderboard ol { list-style: decimal; }
</style>

<div class="top-nav">
    <a class="nav-btn" href="{{ path('app_home') }}">‚Üê Inicio</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game1' %} active-nav{% endif %}" href="{{ path('app_game1') }}">Juego 1</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game2' %} active-nav{% endif %}" href="{{ path('app_game2') }}">Juego 2</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game3' %} active-nav{% endif %}" href="{{ path('app_game3') }}">Juego 3</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game4' %} active-nav{% endif %}" href="{{ path('app_game4') }}">Juego 4</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game5' %} active-nav{% endif %}" href="{{ path('app_game5') }}">Juego 5</a>
    <a class="nav-btn{% if app.request.attributes.get('_route') == 'app_game6' %} active-nav{% endif %}" href="{{ path('app_game6') }}">Juego 6</a>
    {% if is_granted('ROLE_ADMIN') %}
    <a class="nav-btn" href="{{ path('app_admin') }}">Admin</a>
    {% endif %}
    <a class="nav-btn logout" href="{{ path('app_logout') }}">Cerrar sesi√≥n</a>
</div>

<div class="game-container">
    <h1>ü™¢ Ahorcado</h1>
    <p class="subtitle">Adivina la palabra antes de que se complete el dibujo</p>

    <div class="status-bar">
        <div class="status-box">
            <h3>Intentos restantes</h3>
            <p id="lives">6</p>
        </div>
        <div class="status-box">
            <h3>Ganadas</h3>
            <p id="wins">0</p>
        </div>
        <div class="status-box">
            <h3>Perdidas</h3>
            <p id="losses">0</p>
        </div>
    </div>

    <div class="top-row">
        <div class="hangman">
            <canvas id="hangmanCanvas" width="300" height="300"></canvas>
        </div>
        <div class="word-panel">
            <div class="category" id="category"></div>
            <div class="hidden-word" id="hiddenWord">_ _ _ _</div>
            <div class="message" id="message">Pulsa una letra o empieza nueva partida</div>
        </div>
    </div>

    <div class="keyboard" id="keyboard"></div>

    <div class="controls">
        <button class="btn" onclick="newGame()">Nueva palabra</button>
        <button class="btn secondary" onclick="resetScores()">Reiniciar marcador</button>
    </div>

    <div class="instructions">
        <h3>üìñ Instrucciones</h3>
        <ul>
            <li>Selecciona letras desde el teclado en pantalla o con tu teclado f√≠sico.</li>
            <li>Tienes 6 intentos antes de que el mu√±eco se complete.</li>
            <li>Si aciertas todas las letras, ganas la ronda.</li>
            <li>Puedes jugar tantas rondas como quieras; el marcador acumula ganadas y perdidas.</li>
        </ul>
    </div>

    <div class="info-box leaderboard" style="margin-top:20px; max-width:750px; width:100%;">
        <h3>Top 10</h3>
        {% if user %}
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
            <input id="nickname" type="text" placeholder="Tu nombre para el ranking" style="padding:8px;border-radius:8px;border:1px solid #ddd;flex:1;min-width:160px;" />
            <button class="btn" id="submitScoreBtn" onclick="submitScore()">Enviar puntuaci√≥n</button>
            <div style="font-size:13px;color:#555;">
                <div>Victorias: <strong id="statWins">0</strong></div>
                <div>Derrotas: <strong id="statLosses">0</strong></div>
                <div>Aciertos: <strong id="statCorrects">0</strong></div>
            </div>
        </div>

        <ol id="leaderboardList" style="padding-left:18px; margin:0;">
            <li>Cargando...</li>
        </ol>
        <p id="leaderboardStatus" style="font-size:12px;color:#888;margin-top:8px;"></p>
        {% else %}
        <p style="color:#f39c12; font-weight:600;">‚ö† Inicia sesi√≥n para ver el ranking</p>
        {% endif %}
    </div>
</div>

<script>
// Evitar que flechas/espacio hagan scroll en la p√°gina
document.addEventListener('keydown', (e) => {
    if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " ", "Spacebar"].includes(e.key)) {
        e.preventDefault();
    }
});

const words = [
    { word: 'PROGRAMAR', category: 'Tecnolog√≠a' },
    { word: 'SYM FONY', category: 'Framework' },
    { word: 'JAVASCRIPT', category: 'Lenguaje' },
    { word: 'ALGORITMO', category: 'Inform√°tica' },
    { word: 'VARIABLE', category: 'Inform√°tica' },
    { word: 'AHORCADO', category: 'Juego' },
    { word: 'SERVIDOR', category: 'Infraestructura' },
    { word: 'CLIENTE', category: 'Infraestructura' },
    { word: 'PATRON', category: 'Arquitectura' },
    { word: 'CONTROLADOR', category: 'MVC' },
];

const keyboardEl = document.getElementById('keyboard');
const hiddenWordEl = document.getElementById('hiddenWord');
const categoryEl = document.getElementById('category');
const livesEl = document.getElementById('lives');
const messageEl = document.getElementById('message');
const winsEl = document.getElementById('wins');
const lossesEl = document.getElementById('losses');
const canvas = document.getElementById('hangmanCanvas');
const ctx = canvas.getContext('2d');

let currentWord = '';
let guessed = new Set();
let lives = 6;
let wins = 0;
let losses = 0;
let corrects = 0; // Contador de aciertos (letras correctas acertadas)

const drawStages = [drawBase, drawPole, drawBeam, drawRope, drawHead, drawBody, drawArms, drawLegs];

function drawBase() {
    ctx.lineWidth = 6; ctx.strokeStyle = '#5d6d7e';
    ctx.beginPath(); ctx.moveTo(40, 260); ctx.lineTo(260, 260); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(80, 260); ctx.lineTo(80, 60); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(80, 60); ctx.lineTo(200, 60); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(200, 60); ctx.lineTo(200, 90); ctx.stroke();
}
function drawPole() { /* ya dibujado en la base para mantener los pasos compactos */ }
function drawBeam() { /* fusionado */ }
function drawRope() { /* fusionado */ }
function drawHead() {
    ctx.lineWidth = 5; ctx.strokeStyle = '#ff5e62';
    ctx.beginPath(); ctx.arc(200, 110, 22, 0, Math.PI * 2); ctx.stroke();
}
function drawBody() {
    ctx.lineWidth = 5; ctx.beginPath(); ctx.moveTo(200, 132); ctx.lineTo(200, 190); ctx.stroke();
}
function drawArms() {
    ctx.beginPath(); ctx.moveTo(200, 150); ctx.lineTo(172, 175); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(200, 150); ctx.lineTo(228, 175); ctx.stroke();
}
function drawLegs() {
    ctx.beginPath(); ctx.moveTo(200, 190); ctx.lineTo(178, 228); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(200, 190); ctx.lineTo(222, 228); ctx.stroke();
}

function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function pickWord() {
    const item = words[Math.floor(Math.random() * words.length)];
    currentWord = item.word.toUpperCase();
    categoryEl.textContent = 'Categor√≠a: ' + item.category;
}

function updateHiddenWord() {
    const display = currentWord.split('').map(ch => {
        if (ch === ' ') return ' ';
        return guessed.has(ch) ? ch : '_';
    }).join(' ');
    hiddenWordEl.textContent = display;
}

function setMessage(text, color = '#e67e22') {
    messageEl.textContent = text;
    messageEl.style.color = color;
}

function setLives(val) {
    lives = val;
    livesEl.textContent = lives;
}

function enableKeyboard(enable) {
    keyboardEl.querySelectorAll('button').forEach(btn => {
        btn.disabled = !enable || guessed.has(btn.dataset.key);
    });
}

function handleKey(letter) {
    if (lives <= 0 || checkWin()) return;
    if (guessed.has(letter)) return;
    guessed.add(letter);
    const btn = keyboardEl.querySelector(`[data-key="${letter}"]`);
    if (btn) btn.disabled = true;

    if (currentWord.includes(letter)) {
        // Contar cu√°ntas veces aparece la letra en la palabra y sumar a aciertos
        const occurrences = currentWord.split('').filter(ch => ch === letter).length;
        corrects += occurrences;
        updateHiddenWord();
        setMessage('¬°Bien!');
        if (checkWin()) {
            wins++;
            winsEl.textContent = wins;
            setMessage('¬°Has ganado!', '#27ae60');
            enableKeyboard(false);
        }
    } else {
        setLives(lives - 1);
        drawNext();
        setMessage('Fallaste');
        if (lives === 0) {
            losses++;
            lossesEl.textContent = losses;
            setMessage('Has perdido. La palabra era: ' + currentWord, '#c0392b');
            revealWord();
            enableKeyboard(false);
        }
    }
}

let drawStep = 0;
function drawNext() {
    if (drawStep < drawStages.length) {
        drawStages[drawStep++]();
    }
}

function revealWord() {
    hiddenWordEl.textContent = currentWord.split('').join(' ');
}

function checkWin() {
    return currentWord.split('').every(ch => ch === ' ' || guessed.has(ch));
}

function newGame() {
    guessed = new Set();
    setLives(6);
    pickWord();
    updateHiddenWord();
    setMessage('Pulsa una letra para jugar');
    drawStep = 0;
    clearCanvas();
    drawBase();
    corrects = 0;
    enableKeyboard(true);
}

function resetScores() {
    wins = 0; losses = 0;
    winsEl.textContent = wins;
    lossesEl.textContent = losses;
    newGame();
}

function buildKeyboard() {
    const letters = 'ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ'.split('');
    keyboardEl.innerHTML = '';
    letters.forEach(letter => {
        const btn = document.createElement('button');
        btn.className = 'key';
        btn.textContent = letter;
        btn.dataset.key = letter;
        btn.onclick = () => handleKey(letter);
        keyboardEl.appendChild(btn);
    });
}

document.addEventListener('keydown', (e) => {
    const letter = e.key.toUpperCase();
    if (/^[A-Z√ë]$/.test(letter)) {
        handleKey(letter);
    }
});

buildKeyboard();
newGame();
</script>
<script>
    // Gesti√≥n del ranking en localStorage para este juego (Top 10)
    const LB_KEY = 'game4_leaderboard';

    function getLeaderboard() {
        try {
            return JSON.parse(localStorage.getItem(LB_KEY) || '[]');
        } catch (e) { return []; }
    }

    function saveLeaderboard(arr) {
        localStorage.setItem(LB_KEY, JSON.stringify(arr));
    }

    function renderLeaderboard() {
        const listEl = document.getElementById('leaderboardList');
        const statusEl = document.getElementById('leaderboardStatus');
        const data = getLeaderboard();
        listEl.innerHTML = '';
        if (!data.length) {
            listEl.innerHTML = '<li>No hay puntuaciones a√∫n</li>';
            statusEl.textContent = '';
            return;
        }
        data.slice(0,10).forEach(entry => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${entry.name}</strong> ‚Äî Vict: ${entry.wins} | Der: ${entry.losses} | Aciertos: ${entry.corrects}`;
            listEl.appendChild(li);
        });
        statusEl.textContent = `Mostrando ${Math.min(10, data.length)} de ${data.length} entradas`;
    }

    function submitScore() {
        const nameEl = document.getElementById('nickname');
        const name = nameEl.value.trim() || 'Jugador';
        const entry = {
            name: name,
            wins: wins,
            losses: losses,
            corrects: corrects,
            date: new Date().toISOString()
        };
        const arr = getLeaderboard();
        arr.push(entry);
        // Ordenar por wins desc, luego corrects desc
        arr.sort((a,b) => (b.wins - a.wins) || (b.corrects - a.corrects) || (new Date(a.date) - new Date(b.date)));
        saveLeaderboard(arr);
        renderLeaderboard();
        const statusEl = document.getElementById('leaderboardStatus');
        statusEl.textContent = 'Puntuaci√≥n enviada.';
        nameEl.value = '';
    }

    function updateStatDisplays() {
        const w = document.getElementById('statWins');
        const l = document.getElementById('statLosses');
        const c = document.getElementById('statCorrects');
        if (w) w.textContent = wins;
        if (l) l.textContent = losses;
        if (c) c.textContent = corrects;
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderLeaderboard();
        updateStatDisplays();
        // Actualizar stats peri√≥dicamente (por si cambian durante la sesi√≥n)
        setInterval(updateStatDisplays, 500);
    });
</script>
{% endblock %}
