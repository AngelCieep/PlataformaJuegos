{% extends '_navbar.html.twig' %}

{% block title %}Gestión de Usuarios{% endblock %}

{% block page_content %}
<style>
    .content-wrapper {
        background: linear-gradient(135deg, #1B4079 0%, #4D7C8A 100%);
        min-height: calc(100vh - 56px);
        padding: 40px 20px;
    }
    .crud-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { color: #1B4079; margin-bottom: 30px; }
    .btn { padding: 8px 16px; border-radius: 8px; text-decoration: none; display: inline-block; margin: 5px; font-weight: 600; border: none; cursor: pointer; }
    .btn-primary { background: #1B4079; color: white; }
    .btn-success { background: #8FAD88; color: white; }
    .btn-info { background: #4D7C8A; color: white; }
    .btn-danger { background: #E74c3c; color: white; }
    .btn:hover { opacity: 0.9; transform: translateY(-2px); transition: all 0.3s; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; }
    th { background: #f8f9fa; color: #1B4079; font-weight: bold; }
    tr:hover { background: #f8f9fa; }
    .tag { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
    .tag.admin { background: #C7DB94; color: #1B4079; }
    .tag.user { background: #d4edda; color: #155724; }
    .tag.active { background: #8FAD88; color: white; }
    .tag.inactive { background: #e74c3c; color: white; }
</style>

<div class="crud-container">
    <h1><i class="bi bi-people-fill"></i> Gestión de Usuarios</h1>
    
    <div style="margin-bottom: 20px;">
        <a href="{{ path('app_user_new') }}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Crear Nuevo Usuario
        </a>
        <a href="{{ path('app_admin') }}" class="btn btn-primary">
            <i class="bi bi-arrow-left"></i> Volver al Panel
        </a>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Email</th>
                <th>Roles</th>
                <th>Estado</th>
                <th>Fecha Registro</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
        {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.nombre }}</td>
                <td>{{ user.email }}</td>
                <td>
                    <form method="post" action="{{ path('app_user_update_role', {'id': user.id}) }}" style="display: inline;">
                        <select class="form-select form-select-sm" name="role" onchange="this.form.submit()" style="width: auto; display: inline-block;">
                            <option value="ROLE_USER" {% if 'ROLE_ADMIN' not in user.roles and 'ROLE_OWNER' not in user.roles %}selected{% endif %}>Usuario</option>
                            <option value="ROLE_OWNER" {% if 'ROLE_OWNER' in user.roles %}selected{% endif %}>Owner</option>
                            <option value="ROLE_ADMIN" {% if 'ROLE_ADMIN' in user.roles %}selected{% endif %}>Admin</option>
                        </select>
                    </form>
                </td>
                <td>
                    <form method="post" action="{{ path('app_user_update_status', {'id': user.id}) }}" style="display: inline;">
                        <select class="form-select form-select-sm" name="status" onchange="this.form.submit()" style="width: auto; display: inline-block;">
                            <option value="activo" {% if user.estado %}selected{% endif %}>Activo</option>
                            <option value="inactivo" {% if not user.estado %}selected{% endif %}>Inactivo</option>
                        </select>
                    </form>
                </td>
                <td>{{ user.fechaRegistro ? user.fechaRegistro|date('d/m/Y H:i') : '-' }}</td>
                <td>
                    <a href="{{ path('app_user_show', {'id': user.id}) }}" class="btn btn-info">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a href="{{ path('app_user_edit', {'id': user.id}) }}" class="btn btn-primary">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <form method="post" action="{{ path('app_user_delete', {'id': user.id}) }}" style="display: inline;" id="delete-form-{{ user.id }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ user.id) }}">
                        <button type="button" class="btn btn-danger" onclick="confirmDelete({{ user.id }}, '{{ user.nombre }}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="7" style="text-align: center; color: #999;">No hay usuarios registrados</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
function confirmDelete(id, nombre) {
    Swal.fire({
        title: '¿Estás seguro?',
        text: `¿Deseas eliminar el usuario "${nombre}"? Esta acción no se puede deshacer.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#e74c3c',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('delete-form-' + id).submit();
        }
    });
}

{% for type, messages in app.flashes %}
    {% for message in messages %}
        {% if type == 'success' %}
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: '{{ message }}',
                confirmButtonColor: '#1B4079',
                timer: 3000,
                timerProgressBar: true
            });
        {% elseif type == 'error' %}
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: '{{ message }}',
                confirmButtonColor: '#1B4079'
            });
        {% endif %}
    {% endfor %}
{% endfor %}
</script>
{% endblock %}
